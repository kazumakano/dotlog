---
title:       "cmd2sh"
subtitle:    ""
description: "コマンドプロンプトでLinuxコマンドを使う"
date:        2021-07-24
author:      "Kazuma Kano"
image:       true
tags:        [windows]
categories:  [util]
published:   true
---

LinuxやUnixに慣れていると、Windowsのコマンドプロンプトでもつい`ls`とタイプしてしまうことがあります。
コマンドプロンプトには`ls`コマンドがないので、以下のようなメッセージが出力されるだけです。
```cmd
'ls' は、内部コマンドまたは外部コマンド、操作可能なプログラムまたはバッチ ファイルとして認識されていません。
```

もちろん[WSL](https://docs.microsoft.com/ja-jp/windows/wsl/)や[Cygwin](https://www.cygwin.com/)などを使えばWindows上でLinuxやUnixの環境を動かすことも可能です。
しかしここでは、コマンドプロンプトをそのまま利用して、特に頻繁に使ういくつかのLinuxやUnixのコマンドを再現したいと思います。

# doskey Command
コマンドプロンプトには`doskey`というコマンドが用意されています。
これはLinuxやUnixにおける`alias`コマンドのようなもので、既存のコマンドを組み合わせて新しいコマンドを定義することができます。

これを利用すれば、例えば既存の`dir`コマンドに`ls`という別の名称をつけることもできます。
すると、`ls`コマンドを実行したら内部的に`dir`コマンドが呼ばれるようになります。

まず、エイリアスの設定を記述した以下のようなファイルを作成します。
ファイル名は何でも良いです。
詳しい構文については[公式のドキュメント](https://docs.microsoft.com/ja-jp/windows-server/administration/windows-commands/doskey)を参照してください。
```
cat      = type $*
cd       = if "$1"=="" (cd %HOMEPATH%) else (cd $*)
clear    = cls
cp       = copy $*
ifconfig = ipconfig $*
ls       = dir /b $*
mv       = move $*
open     = start $*
pwd      = cd $*
rm       = del $*
```

いくつか解説します。

新しく定義した`cd`コマンドは、引数がなければホームディレクトリに移動し、引数があれば元々のコマンドプロンプトの`cd`コマンドとして振る舞うようにしています。
このようにした理由は、元々の`cd`コマンドは引数がないとただカレントディレクトリを出力するという動作をするためです。

また、この元々の`cd`コマンドの動作を利用して、LinuxやUnixの`pwd`コマンドを再現しています。
`$*`が必要ないように思うかもしれませんが、これは出力をパイプやリダイレクトに渡せるようにするためです。

`ls`コマンドについては、そのままの`dir`コマンドだと使いにくいので、`/b`オプションを付けることでよりLinuxやUnixの`ls`コマンドっぽく動作するようにしています。

続いて、`doskey`コマンドを実行してエイリアスの設定を反映します。
`/macrofile`オプションで先ほど作成したファイルへのパスを指定します。
```cmd
doskey /macrofile=path¥to¥file
```

# Batch File
`doskey`コマンドによるエイリアスの設定にはいくつか不便な点があります。
その内の一つに、`doskey`コマンドで定義したコマンドはパイプやリダイレクトから入力を受け取れないという点が挙げられます。
そこで、パイプやリダイレクトから入力を受け取る前提のコマンドについては、バッチファイルで再現します。

バッチファイルとは、一連の命令文を記述したファイルのことで、LinuxやUnixにおけるシェルスクリプトに相当します。
拡張子は.cmdや.batが使われます。
バッチファイルの実行にはコマンドを必要とせず、拡張子を省略したファイル名でそのまま呼び出すことができます。

これを利用すれば、例えば`grep`コマンドの動作を記述したバッチファイルに`grep.cmd`という名前をつけることで、擬似的に`grep`コマンドを再現することができます。
ただし、どこからでも使えるようにするためにはパスを通してやる必要があります。

まず、バッチファイルを作成します。
以下は`grep.cmd`の実装例です。
```
@echo You can use ".*" as wild card
@echo.
@findstr /n %*
```

コマンドプロンプトの`findstr`コマンドを利用しています。
ワイルドカードの仕様がややこしいので、`echo`コマンドでその旨の文章を表示しています。
命令文の前に`@`を付けることで、命令文をいちいちコンソールに出力しないようにしています。

続いて、先ほど作成したバッチファイルが置いてあるディレクトリにパスを通します。
```cmd
set PATH=%PATH%path¥to¥dir;
```

# Release
今回作成したファイルはこちらの[GitHubリポジトリ](https://github.com/kazumakano/cmd2sh)に置いてあります。

リポジトリには以下のファイルが含まれます。
`shrc.cmd`には、エイリアス設定を読み込ませてバッチファイルにパスを通すための命令文が記述されています。
- grep.cmd
- macrofile
- shrc.cmd
- wc.cmd

## Install
以下の手順に従ってコマンドプロンプトに適用していただけます。

まず、リポジトリからファイルをクローンあるいはzip形式でダウンロードしてください。

続いて、cmd2shディレクトリをルートディレクトリ`C:¥`に移動してください。
他のディレクトリに置いていただくこともできますが、その場合は`shrc.cmd`のパスを適宜変更してください。

最後に、コマンドプロンプトに設定を読み込ませます。
コマンドプロンプトのショートカット > 右クリック > プロパティ を選択すると以下のようなウィンドウが表示されます。
ショートカットがない場合は、スタート > コマンドプロンプト > ファイルの場所を開く からショートカットが置いてあるディレクトリを開くことができます。
![Command Prompt Property](../../img/post-20210724-01.png)

リンク先の命令文に以下のように`/k`オプションを追加してください。
リンク先というのはショートカット選択時に実行される命令のことです。
`cmd`コマンドが実行されることでコマンドプロンプトが新しく起動するようになっています。
`/k`オプションで起動時に実行する命令文を指定できます。
```
%windir%\system32\cmd.exe /k C:¥cmd2sh¥shrc.cmd
```

これで、コマンドプロンプトを起動する度に`shrc.cmd`を実行させることで、自動でエイリアス設定を読み込むとともにバッチファイルへのパスを通してくれるようになりました。

## Uninstall
プロパティ > リンク先 の欄から再度`/k`オプションを削除することで、設定が自動で読み込まれなくなります。

面倒ですが、`doskey`コマンドと`set`コマンドを使ってその都度ON/OFFすることもできます。
